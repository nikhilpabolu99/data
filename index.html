<script>
    class DynamicFolderBrowser {
        constructor() {
            this.currentPath = [];
            this.contentElement = document.getElementById('content');
            this.breadcrumbElement = document.getElementById('breadcrumb');
            this.basePath = 'movies'; // Base path for your folders
            
            // Your API endpoints
            this.apiFoldersEndpoint = '/api/folders';
            this.apiFileEndpoint = '/api/file';
            
            this.init();
        }

        init() {
            this.updateBreadcrumb();
            this.setupEventListeners();
            this.loadFolders(); // Load initial folders on page load
        }

        setupEventListeners() {
            // Note: Removed the basePath input and scan button for simplicity.
            // The browser will now automatically load from `this.basePath`.
            document.getElementById('refreshBtn').onclick = () => this.refreshCurrentView();
        }

        async refreshCurrentView() {
            await this.loadFolders();
        }

        async fetchFolderContents(path = []) {
            const fullPath = [this.basePath, ...path].join('/');
            
            this.contentElement.innerHTML = '<div class="loading">Scanning folders...</div>';

            try {
                const response = await fetch(`${this.apiFoldersEndpoint}?path=${encodeURIComponent(fullPath)}`);
                const data = await response.json();
                
                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Failed to fetch folder contents.');
                }
                
                return data;
            } catch (error) {
                console.error('Error fetching folder contents:', error);
                throw error;
            }
        }

        async loadFolders() {
            this.updateBreadcrumb();
            
            try {
                const data = await this.fetchFolderContents(this.currentPath);
                
                if (!data) {
                    this.showError('Failed to load folder contents.');
                    return;
                }

                this.renderFolderContents(data);
                
            } catch (error) {
                console.error('Error loading folders:', error);
                this.showError(`Error loading folders: ${error.message}`);
            }
        }

        renderFolderContents(data) {
            const { folders = [], files = [] } = data;
            let content = '<div class="fade-in">';

            if (folders.length > 0) {
                content += '<div class="folder-grid">';
                folders.forEach(folder => {
                    const icon = this.getFolderIcon(folder);
                    content += `
                        <button class="folder-btn" onclick="browser.navigateToFolder('${this.escapeHtml(folder)}')">
                            <span class="folder-icon">${icon}</span>
                            <span class="folder-name">${this.escapeHtml(folder)}</span>
                            <span class="folder-info">Folder</span>
                        </button>
                    `;
                });
                content += '</div>';
            }

            const jsonFiles = files.filter(file => file.endsWith('.json'));
            if (jsonFiles.length > 0) {
                content += this.renderJsonFiles(jsonFiles);
            }

            if (folders.length === 0 && files.length === 0) {
                content += '<div class="error">No folders or files found in this directory.</div>';
            } else if (folders.length === 0 && jsonFiles.length === 0) {
                content += `<div class="error">Found ${files.length} files, but no JSON files to display.</div>`;
            }

            content += '</div>';
            this.contentElement.innerHTML = content;
        }

        renderJsonFiles(jsonFiles) {
            let content = '<div class="json-content"><div class="json-header">📄 JSON Files Found</div><div class="json-grid">';
            
            jsonFiles.forEach(file => {
                content += `
                    <div class="json-item" onclick="browser.loadJsonFile('${this.escapeHtml(file)}')">
                        <div class="json-key">${this.escapeHtml(file)}</div>
                        <div class="json-preview">Click to load content</div>
                    </div>
                `;
            });
            
            content += '</div></div>';
            return content;
        }

        getFolderIcon(folderName) {
            const name = folderName.toLowerCase();
            if (name.includes('movie') || name.includes('film')) return '🎬';
            if (name.includes('action')) return '💥';
            if (name.includes('comedy')) return '😂';
            if (name.includes('drama')) return '🎭';
            return '📁';
        }

        async navigateToFolder(folder) {
            this.currentPath.push(folder);
            await this.loadFolders();
        }

        async navigateTo(path) {
            this.currentPath = [...path];
            await this.loadFolders();
        }

        updateBreadcrumb() {
            this.breadcrumbElement.innerHTML = '';
            
            const homeItem = document.createElement('span');
            homeItem.className = 'breadcrumb-item';
            homeItem.textContent = '🏠 ' + this.basePath;
            homeItem.onclick = () => this.navigateTo([]);
            this.breadcrumbElement.appendChild(homeItem);

            this.currentPath.forEach((item, index) => {
                const separator = document.createElement('span');
                separator.className = 'breadcrumb-separator';
                separator.textContent = '/';
                this.breadcrumbElement.appendChild(separator);

                const pathItem = document.createElement('span');
                pathItem.className = index === this.currentPath.length - 1 ? 'breadcrumb-item active' : 'breadcrumb-item';
                pathItem.textContent = item;
                if (index < this.currentPath.length - 1) {
                    pathItem.onclick = () => this.navigateTo(this.currentPath.slice(0, index + 1));
                }
                this.breadcrumbElement.appendChild(pathItem);
            });
        }

        async loadJsonFile(filename) {
            const fullPath = [this.basePath, ...this.currentPath, filename].join('/');
            this.contentElement.innerHTML += '<div class="loading">Loading file...</div>';

            try {
                const response = await fetch(`${this.apiFileEndpoint}?path=${encodeURIComponent(fullPath)}`);
                if (response.ok) {
                    const jsonData = await response.json();
                    this.displayJsonData(filename, jsonData);
                } else {
                    throw new Error(`Failed to load file: ${response.statusText}`);
                }
            } catch (error) {
                this.showError(`Error loading JSON file: ${error.message}`);
            }
        }

        displayJsonData(filename, data) {
            const existingDisplay = document.querySelector('.data-display');
            if (existingDisplay) {
                existingDisplay.remove();
            }

            const displayDiv = document.createElement('div');
            displayDiv.className = 'data-display fade-in';
            displayDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #6366f1; margin: 0;">📊 ${this.escapeHtml(filename)}</h3>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; color: #ef4444; padding: 5px 10px; border-radius: 6px; cursor: pointer;">Close</button>
                </div>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            
            this.contentElement.appendChild(displayDiv);
            displayDiv.scrollIntoView({ behavior: 'smooth' });
        }

        showError(message) {
            this.contentElement.innerHTML = `<div class="error"><h3>Error</h3><p>${this.escapeHtml(message)}</p></div>`;
        }

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    }

    const browser = new DynamicFolderBrowser();
</script>
